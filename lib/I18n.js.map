{"version":3,"sources":["../src/I18n.js"],"names":[],"mappings":"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","file":"I18n.js","sourcesContent":["import {fetchSetup, fetchTranslations} from './Api';\nimport {ng} from 'fd-angular-core';\n\nlet $current = new Symbol('$current');\nlet $default = new Symbol('$default');\nlet $locales = new Symbol('$locales');\nlet $cache = new Symbol('$cache');\nlet $setup = new Symbol('$setup');\nlet $fetchSetup = new Symbol('$fetchSetup');\n\n/**\n@namespace I18n\n*/\n\nclass I18nService {\n\n\tconstructor() {\n\t\tthis[$cache] = {};\n\t}\n\n\t/**\n\tReturns the current (or closest) locale.\n\n\t@var {String} current\n\t@memberof I18n\n\t*/\n\tget current() { return this[$current]; }\n\n\tget default() { return this[$default]; }\n\n\t/**\n\tReturns the list of available locales.\n\n\t@var {String[]} locales\n\t@memberof I18n\n\t*/\n\tget locales() { return this[$locales]; }\n\n\t[$fetchSetup]() {\n\t\tif (this[$setup]) {\n\t\t\treturn this[$setup];\n\t\t}\n\n\t\tthis[$setup] = fetchSetup()\n\t\t\t.then(setup => {\n\t\t\t\tthis[$default] = setup.default;\n\t\t\t\tthis[$current] = setup.default;\n\t\t\t\tthis[$locales] = setup.locales;\n\n\t\t\t\tif (navigator.language) {\n\t\t\t\t\tlet locale = navigator.language.split('-')[0];\n\t\t\t\t\tif (setup.locales.indexOf(locale)) {\n\t\t\t\t\t\tthis[$current] = locale;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\treturn this[$setup];\n\t}\n\n\t/**\n\tReturns a promise that resolves when the I18n service is ready with its setup.\n\n\t@function ready\n\t@memberof I18n\n\t@returns {Promise.<I18n>}\n\t*/\n\tready() {\n\t\treturn this[$fetchSetup]().then(() => this);\n\t}\n\n\n\t/**\n\tReturns a promise that returns all the translated keys for the provided locale.\n\n\t@function fetch\n\t@memberof I18n\n\t@param {String} locale\n\t@returns {Promise.<Object>}\n\t*/\n\tfetch(locale) {\n\t\tif (this[$cache][locale]) {\n\t\t\treturn this[$cache][locale];\n\t\t}\n\n\t\tthis[$cache][locale] = this[$fetchSetup]()\n\t\t\t.then(() => {\n\t\t\t\treturn Promise.all([\n\t\t\t\t\tfetchTranslations(this.default),\n\t\t\t\t\tfetchTranslations(locale),\n\t\t\t\t]).then(deepMerge);\n\t\t\t});\n\n\t\treturn this[$cache][locale];\n\t}\n\n}\n\nexport var I18n = new I18nService();\n\nfunction deepMerge(stack) {\n\tlet base = {};\n\n\tfor (let level of stack) {\n\t\tdeepApply(base, level);\n\t}\n\n\treturn base;\n\n\tfunction deepApply(dst, src) {\n\t\tfor (let key of Object.keys(src)) {\n\t\t\tlet val = src[key];\n\n\t\t\tif (ng.isObject(val)) {\n\t\t\t\tlet val2 = (dst[key] || {});\n\t\t\t\tdeepApply(val2, val);\n\t\t\t\tdst[key] = val2;\n\t\t\t} else {\n\t\t\t\tdst[key] = val;\n\t\t\t}\n\t\t}\n\t}\n}\n"]}