{"version":3,"sources":["../src/I18nService.js"],"names":[],"mappings":"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","file":"I18nService.js","sourcesContent":["import {fetchSetup, fetchTranslations} from './Api';\nimport {ng, Inject} from 'fd-angular-core';\n\nlet $current = Symbol('$current');\nlet $default = Symbol('$default');\nlet $locales = Symbol('$locales');\nlet $cache = Symbol('$cache');\nlet $setup = Symbol('$setup');\nlet $fetchSetup = Symbol('$fetchSetup');\n\n/**\n@namespace I18n\n*/\n\n@Inject('$rootScope')\nexport class I18n {\n\n\tconstructor($rootScope) {\n\t\tthis[$cache] = {};\n\t}\n\n\t/**\n\tReturns the current (or closest) locale.\n\n\t@var {String} current\n\t@memberof I18n\n\t*/\n\tget current() { return this[$current]; }\n\n\tget default() { return this[$default]; }\n\n\t/**\n\tReturns the canonical version for the current absUrl\n\n\t@memberof I18n\n\t*/\n\tget canonical() {\n\t\tlet url = window.location.href,\n\t\t\tlocale = (/\\/([a-z]{2})\\//gi).exec(url);\n\n\t\tif (locale) {\n\t\t\tif (locale[1] === this[$default]) {\n\t\t\t\turl = url.split('/');\n\t\t\t\turl.splice(3, 1);\n\t\t\t\turl = url.join('/');\n\t\t\t}\n\t\t} else {\n\t\t\tif (this[$current] !== this[$default]) {\n\t\t\t\turl = url.split('/');\n\t\t\t\turl.splice(3, 0, this[$current]);\n\t\t\t\turl = url.join('/');\n\t\t\t}\n\t\t}\n\n\t\treturn url;\n\t}\n\n\t/**\n\tReturns the list of available locales.\n\n\t@var {String[]} locales\n\t@memberof I18n\n\t*/\n\tget locales() { return this[$locales]; }\n\n\t[$fetchSetup]() {\n\t\tif (this[$setup]) {\n\t\t\treturn this[$setup];\n\t\t}\n\n\t\tthis[$setup] = fetchSetup()\n\t\t\t.then(setup => {\n\t\t\t\tthis[$default] = setup.default;\n\t\t\t\tthis[$locales] = setup.locales;\n\t\t\t\tthis[$current] = this.extractLocaleFromPath(window.location.pathname);\n\t\t\t});\n\n\t\treturn this[$setup];\n\t}\n\n\textractLocaleFromPath(path) {\n\t\tlet locale;\n\n\t\tif (path.indexOf('/') === 0) {\n\t\t\tpath = path.slice(1);\n\t\t}\n\n\t\tlocale = path.split('/');\n\n\t\tif (!!locale[0] && locale[0].length === 2 && this[$locales].indexOf(locale[0]) > -1) {\n\t\t\tlocale = locale[0];\n\t\t} else if (navigator.language) {\n\t\t\tlocale = navigator.language.split('-')[0];\n\t\t} else {\n\t\t\tlocale = this[$default];\n\t\t}\n\n\t\tif (this[$locales].includes(locale)) {\n\t\t\treturn locale;\n\t\t}\n\n\t\treturn this[$default];\n\t}\n\n\tupdate() {\n\t\tlet locale = this.extractLocaleFromPath(window.location.pathname);\n\n\t\tif (locale !== this[$current]) {\n\t\t\tthis[$current] = locale;\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\tReturns a promise that resolves when the I18n service is ready with its setup.\n\n\t@function ready\n\t@memberof I18n\n\t@returns {Promise.<I18n>}\n\t*/\n\tready() {\n\t\treturn this[$fetchSetup]().then(() => this);\n\t}\n\n\n\t/**\n\tReturns a promise that returns all the translated keys for the provided locale.\n\n\t@function fetch\n\t@memberof I18n\n\t@param {String} locale\n\t@returns {Promise.<Object>}\n\t*/\n\tfetch(locale) {\n\t\tif (this[$cache][locale]) {\n\t\t\treturn this[$cache][locale];\n\t\t}\n\n\t\tthis[$cache][locale] = this[$fetchSetup]()\n\t\t\t.then(() => {\n\t\t\t\treturn Promise.all([\n\t\t\t\t\tfetchTranslations(this.default),\n\t\t\t\t\tfetchTranslations(locale),\n\t\t\t\t]).then(deepMerge);\n\t\t\t});\n\n\t\treturn this[$cache][locale];\n\t}\n\n}\n\nfunction deepMerge(stack) {\n\tlet base = {};\n\n\tfor (let level of stack) {\n\t\tdeepApply(base, level);\n\t}\n\n\treturn base;\n\n\tfunction deepApply(dst, src) {\n\t\tfor (let key of Object.keys(src)) {\n\t\t\tlet val = src[key];\n\n\t\t\tif (ng.isObject(val)) {\n\t\t\t\tlet val2 = (dst[key] || {});\n\t\t\t\tdeepApply(val2, val);\n\t\t\t\tdst[key] = val2;\n\t\t\t} else {\n\t\t\t\tdst[key] = val;\n\t\t\t}\n\t\t}\n\t}\n}\n"]}